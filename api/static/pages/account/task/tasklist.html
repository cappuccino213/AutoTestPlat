<!DOCTYPE html>

<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>任务列表</title>
    <link rel="stylesheet" type="text/css" href="../../../assets/iview/iview-3.1.0/styles/iview.css" />
    <script src="../../../assets/vue/vue-2.5.17.min.js"></script>
    <script src="../../../assets/iview/iview-3.1.0/iview.min.js"></script>
    <script src="../../../assets/axios/axios.js"></script>
    <script src="../../../js/config.js"></script>
    <script src="../../../js/locust.js"></script>
    <script src="../../../js/interface.js"></script>
</head>

<body>
<div id="app">
    <i-Button type="primary" @click="modal1 = true">添加任务</i-Button>
    <Modal
            v-model="modal1"
            title="添加任务"
            @on-ok="ok"
            @on-cancel="cancel"

    >
        <i-form ref="formValidate" :model="formValidate" :rules="ruleValidate" :label-width="80">
            <Form-item label="任务名称" prop="task_name">
                <i-input v-model="task_name" placeholder="请输入产品名称"></i-input>
            </Form-item>
            <Form-item label="类型" prop="host">
                <Radio-Group v-model="task_typeID" >
                    <Radio label="1">性能</Radio>
                    <Radio label="2">接口</Radio>
                </Radio-Group>
            </Form-item>
            <Form-item label="性能CASE列表"   v-if="task_typeID=== '1'">
<!--                <dl v-for="(item,index) in performance" :key="item">
                    <label>
                        <input type="checkbox" v-model="case_token" :value="item">
                    </label>
                    {{item.case_name}}

                </dl>-->
                <i-Table   @on-selection-change="handleSelectRow"  highlight-row :border="showBorder" :stripe="showStripe" :show-header="showHeader"
                          :weight='800':height="fixedHeader ? 250 : ''"
                          :size="tableSize" :data="performance" :columns="tableColumns" ref="selection"></i-Table>
            </Form-item>
            <Form-item label="接口CASE列表"   v-if="task_typeID=== '2'">
                <dl v-for="(item,index) in interface" :key="index">
                    <label >
                        <input type="checkbox" v-model="case_token" :value="item">
                    </label>
                    {{item.case_name}}

                </dl>
            </Form-item>
        </i-form>

    </Modal>
    <i-Table :loading="loading" :border="showBorder" :stripe="showStripe" :show-header="showHeader"
             :height="fixedHeader ? 250 : ''" :size="tableSize" :data="tableData3" :columns="tableColumns3"></i-Table>

    <Modal
            v-model="editFormVisible"
            title="编辑任务"
            @on-ok="update"
            @on-cancel="cancel"
    >
        <i-form ref="editForm" :model="editForm" :rules="ruleValidate" :label-width="80">
            <Form-item label="任务名称" prop="task_name">
                <i-input v-model="editForm.task_name" placeholder="请输入产品名称"></i-input>
            </Form-item>
            <Form-item label="任务列型" v-if="editForm.type_id===1">
                <i-Input  value="性能"  readonly=true placeholder="Enter something..." />
            </Form-item>
            <Form-item label="任务列型" v-if="editForm.type_id===2">
                <i-Input value="接口" readonly=true placeholder="Enter something..." />
            </Form-item>
            <form-item label="任务列表">
    <!--             <dl v-for="(item,index) in this.editForm.per" :key="index">
                <label >
                 <input type="checkbox" v-model="case_token" :value="item">
                </label>{{item.case_name}}
                 </dl>-->
                <i-Table  @on-selection-change="handleSelectRow"  highlight-row :border="showBorder" :stripe="showStripe" :show-header="showHeader"
                          :weight='800':height="fixedHeader ? 250 : ''"
                          :size="tableSize" :data="this.editForm.per" :columns="tableColumns" ref="selection"></i-Table>
            </form-item>
        </i-form>

    </Modal>
    <Modal v-model="win" fullscreen title="任务参数"
           @on-ok="addtaskwin"
           @on-cancel="cancel"
    >
        <i-Table  @on-selection-change="handleSelectWin" :loading="loading" :border="showBorder" :stripe="showStripe" :show-header="showHeader"
                 :height="fixedHeader ? 250 : ''" :size="tableSize" :data="taskwin" :columns="winColumns" ref="selection"></i-Table>
    </Modal>

</div>
<script type="text/javascript">
    var vm = new Vue({
        el: "#app",
        data: function () {
            return {
                win:false,
                addtaskdata:'',
                taskwin:[],
                loading: false,
                task_name:'',
                checkedNames:[],
                case_pdt0:'',
                case_pdt:'',
                case_apidata:'',
                case_token:[],
                selection:[],
                case_input:[],
                task_typeID:'',
                casedate:[{
                    "case_name": "按需服务1",
                    "api_weight": [
                        {
                            "api_id": "20",
                            "weight": "1"
                        },
                        {
                            "api_id": "21",
                            "weight": "1"
                        },
                    ],
                    "type_id": '1',
                }],
                editFormVisible:false,
                editFormRules: {
                    name: [
                        { required: true, message: '请输入姓名', trigger: 'blur' }
                    ]
                },
                editForm: {
                    pdt_id:'' ,
                    pdt_name: '',
                    version: '',
                    host: '',
                    description: '',
                    api_json:'',

                },
                modal1: false,
                formValidate: {
                    type_id:'1',
                },
                ruleValidate: {
                    pdt_name: [
                        { required: true, message: '产品名称不能为空', trigger: 'blur' }
                    ],
                    host: [
                        { required: true, message: '产品地址不能为空', trigger: 'blur' }
                    ],
                    version: [
                        { required: true, message: '产品版本不能为空', trigger: 'blur' }
                    ],
                    description: [
                        { required: true, message: '请输入产品描述', trigger: 'blur' },
                    ],
                    api_json: [
                        { required: true, message: '产品接口字符串不能为空', trigger: 'blur' }
                    ]
                },
                tableData3: [

                ],
                showBorder: false, // 显示边框
                showStripe: true, // 是否显示斑马纹
                showHeader: true, // 是否显示头部信息
                showIndex: false, // 是否显示索引
                showCheckbox: true, // 显示多选框
                fixedHeader: false, // 显示滑动
                tableSize: 'default',
                interface:[],
                performance:'',

            }
        },
        computed: {
            tableColumns3: function () {
                let columns = [];
                if (this.showCheckbox) {
                    columns.push({
                        type: 'selection',
                        width: 60,
                        align: 'center'
                    })
                }
                if (this.showIndex) {
                    columns.push({
                        type: 'index.html--',
                        width: 60,
                        align: 'center'
                    })
                }
                columns.push({
                    title: 'ID',
                    key: 'task_id',
                    sortable: true,

                });

                columns.push({
                    title: '任务名称',
                    key: 'task_name'
                });
                columns.push({
                    title: '运行状态',
                    key: 'task_status',
                    width:200,
                });
                columns.push({
                    title: '任务类型',
                    key: 'type_id',
                    render: (h, params) => {
                        return  h('span',params.row.type_id === 1 ?'性能' : params.row.type_id === 2? '接口' : '未知')
                    }
                });

                columns.push({
                    title: '运行参数',
                    key: 'parameter',
                    tooltip:true,
                    width:300,
                });
                columns.push({
                    title: '任务执行',
                    key: 'action',
                    render: (h, params) => {
                        return h('div', [
                            h('Button', {
                                props: {

                                    icon:"md-paper",//生成脚本
                                    size: 'buttonSize'
                                },
                                style: {
                                    marginRight: '5px'
                                },
                                on: {
                                    click: () => {
                                        this.addsript(params.row)
                                    }
                                }
                            }),
                            h('Button', {
                                props: {
                                    icon:"md-play",//运行

                                    size: 'buttonSize'

                                },
                                style: {
                                    marginRight: '5px',
                                    display:(params.row.task_status===true)?"none":"inline-block",
                                },
                                on: {
                                    click: () => {
                                        this.taskrun(params.row)
                                    }
                                }
                            }),
                            h('Button', {
                                props: {
                                    icon:"md-pause",//停止

                                    size: 'buttonSize'
                                },
                                style: {
                                    marginRight: '5px',
                                    display:(params.row.task_status===false)?"none":"inline-block",
                                },
                                on: {
                                    click: () => {
                                        this.taskstop(params.row)
                                    }
                                }
                            }, ),
                            h('Button', {
                                props: {
                                    icon:"md-cog",//编辑参数

                                    size: 'buttonSize'
                                },
                                style: {
                                    marginRight: '5px',
                                },
                                on: {
                                    click: () => {
                                        this.taskupdate(params.row);
                                    }
                                }
                            }, ),
                        ])
                    }
                });
                columns.push({
                    title: 'Action',
                    key: 'action',
                    render: (h, params) => {
                        return h('div', [
                            h('Button', {
                                props: {
                                    type: 'primary',
                                    icon:"ios-create-outline",//编辑
                                    shape:"circle",
                                    size: 'buttonSize'
                                },
                                style: {
                                    marginRight: '5px'
                                },
                                on: {
                                    click: () => {
                                        this.show(params.row)
                                    }
                                }
                            },'编辑'),
                            h('Button', {
                                props: {
                                    type: 'error',
                                    icon:"ios-trash-outline",//删除
                                    shape:"circle",
                                    size: 'buttonSize'
                                },
                                on: {
                                    click: () => {
                                        this.remove(params.index)
                                    }
                                }
                            },'删除')
                        ])
                    }
                });
                console.log("columns" + JSON.stringify(columns));
                return columns
            },
            tableColumns:function(){
                let columns = [];
                if (this.showCheckbox) {
                    columns.push({
                        type: 'selection',
                        width: 60,
                        align: 'center'
                    })
                }
                if (this.showIndex) {
                    columns.push({
                        type: 'index.html--',
                        width: 60,
                        align: 'center'
                    })
                }
                columns.push({
                    title: '任务名称',
                    key: 'case_name',


                });
                return columns
            },
            winColumns:function(){
                let columns = [];
                if (this.showCheckbox) {
                    columns.push({
                        type: 'selection',
                        width: 60,
                        align: 'center'
                    })
                }
                if (this.showIndex) {
                    columns.push({
                        type: 'index.html--',
                        width: 60,
                        align: 'center'
                    })
                }
                columns.push({
                    title: '参数名称',
                    key: 'parameter',
                });
                columns.push({
                    title: '参数值',
                    key: 'winvalue',
                    render: (h, params) => {
                        return h('div', [
                            h('Input', {
                                props: {
                                    shape:"circle",
                                    size: 'buttonSize',
                                    value:this.taskwin[params.index].winvalue,
                                    readonly:this.taskwin[params.index].status
                                    //display:true
                                    //type:'textarea',
                                    //autosize:{minRows:1,maxRows:3},



                                },
                                style: {
                                    marginRight: '5px',
                                },
                                on: {
                                    'on-change': (event) => {

                                        console.log('a：'+JSON.stringify(event));
                                        console.log('b：'+JSON.stringify(params.row));
                                        console.log('c：'+params.row.action);
                                        console.log('d：'+params.index);
                                        this.$refs.selection.objData[params.index]._isChecked=false;
                                        this.$refs.selection.toggleSelect(params.index);
                                        this.taskwin[params.index].winvalue=event.target.value;
                                        console.log("fan："+JSON.stringify(this.taskwin[params.index]));

                                    }
                                }
                            })
                        ])
                    }
                });
                columns.push({
                    title: '参数说明',
                    key: 'description',
                });
                return columns
            },
        },
        watch:{
task_typeID(val,oldval){
    var  performance0=[];
    var  interface0=[];
        console.log("val:"+val);
    console.log("shouw3"+JSON.stringify(this.case_pdt));
        for(var i=0;i<this.case_pdt.length;i++){
            if(this.case_pdt[i].type_id===1){
                performance0.push({
                    case_id:this.case_pdt[i].case_id,
                    case_name:this.case_pdt[i].case_name,
                })
                //console.log("performance0:"+performance0)
            }
            else if(this.case_pdt[i].type_id===2){
                interface0.push({
                    case_id:this.case_pdt[i].case_id,
                    case_name:this.case_pdt[i].case_name,
                })
                //console.log("interface0:"+interface0)

            }
        }
    this.performance=performance0;
    this.interface=interface0;
/*    console.log("performance1:"+performance0)
    console.log("interface1:"+interface0)
    console.log("interfance2:"+JSON.stringify(this.interface))*/
}
        },

        created:function(){
            axios.get(''+host+'/api/taskinfo/taskmagager')
            //axios.get(''+host+'/api/taskinfo/tasklist')
                .then(res => {
                    console.log(res);
                    /*this.tableData3 = res.data.message*/
                    //this.filters=this.tableData3.pdt_name
                    this.tableData3=res.data.message;
                    console.log("task2:"+this.tableData3.length);
                    axios.get(''+host+'/api/caseinfo/caselist')
                        .then(res => {
                            console.log(res);
                            this.case_pdt = res.data.message;
                            console.log("task4:"+this.tableData3.length);
                            console.log(this.case_pdt)
                        })
                        .catch(function (error) {
                            console.log(error)
                        });
                    console.log("task3:"+this.case_pdt)
                })
                .catch(function (error) {
                    console.log(error)
                });

        },
        mounted:function(){
            console.log("task:"+this.tableData3.length)
        },
        methods:{//列表点击
            handleSelectRow:function(selection,row) {

                //console.log('11:'+JSON.stringify(this.$refs.selection.getslection()));
                /* console.log('1:'+this.tableData[0].action);*/
                // console.log('11:'+selection.selectionIndexes);
                console.log('21:'+JSON.stringify(row));
                console.log('31:'+JSON.stringify(selection));
                //console.log('32:'+index);
                this.selection=selection;
                //console.log("fan："+JSON.stringify(this.case_apidata[params.index]));
            },
            handleSelectWin:function(selection,row){
                console.log('jj1:'+JSON.stringify(selection));
                this.selection=selection
            },
            //脚本生成
            addsript:function(event) {
                console.log("cs；" + JSON.stringify(event));
                if (event.type_id === 1) {
                    console.log("cs1；" + event.task_id);
                    axios.get('' + host + '/api/taskscript-performance?task_id=' + event.task_id + '')
                        .then(res => {
                            console.log(res);
                            alert("操作:" + res.data.title + ",\n结果:" + res.data.message)
                        })
                        .catch(function (error) {
                            (error)
                        });
                } else if (event.type_id === 2) {
                    console.log("cs2；" + JSON.stringify(event));
                    axios.get('' + host + '/api/taskscript-interface?task_id=' + event.task_id + '')
                        .then(res => {
                            console.log(res);
                            alert("操作:" + res.data.title + ",\n结果:" + res.data.message)
                        })
                        .catch(function (error) {
                            alert(error)
                        });
                }
            },
            //运行停止
            taskrun:function(event){
                console.log("taskrun；" + JSON.stringify(event));
                if (event.type_id === 1) {
                    console.log("run1；" + event.task_id);
                    console.log("locust1:"+event.parameter);
                    axios.get('' + host + '/api/task-performance?order=1&task_id=' + event.task_id + '')
                        .then(res => {
                            axios.gete('' + host + '/api/taskinfo/task?tid=' + event.task_id + '')
                                .then(res=>{
                                    //event.task_status=true;
                                    console.log("locust2:"+JSON.stringify(res.data.message.locust_cl));
                                    console.log(res);
                                    alert("操作:" + res.data.title + ",\n结果:" + res.data.message);
                                    var locust=event.parameter;
                                    console.log("locust2:"+JSON.stringify(locust));
                                    console.log("locust:"+event.parameter);
                                    for( var i=0;i<locust.length;i++){
                                        var str = locust[i].parameter;
                                        var reg = RegExp(/=/);
                                        var reg0 = RegExp(/--web-host/);
                                        var reg1 = RegExp(/--web-port/);
                                        var reg2 = RegExp(/--no-web/);
                                        if (str.match(reg0)) {
                                            arr = str.split("=");
                                            var webhost = arr[1];
                                        }
                                        if (str.match(reg1)) {
                                            arr = str.split("=");
                                            var webport = arr[1];
                                        }
                                        if (str.match(reg2)) {
                                            var noweb = true;
                                        } else {
                                            var noweb = false;
                                        }
                                    }
                                    /*                            console.log("webhost" + webhost);
                                                                console.log("webport:" + webport);
                                                                console.log("webport2:" + noweb);*/
                                    if (noweb == false) {
                                        weburl = 'http://' + webhost + ':' + webport;
                                        console.log("weburl:" + weburl);
                                        window.open(weburl);

                                    }
                                })
                        })
                        .catch(function (error) {
                            (error)
                        });
                } else if (event.type_id === 2) {
                    this.loading=true;
                    console.log("cs2；" + JSON.stringify(event));
                    axios.get('' + host + '/api/task-interface?task_id=' + event.task_id + '')
                        .then(res => {
                            console.log(res);
                            this.loading=false;
                            alert("操作:" + res.data.title + ",\n结果:" + res.data.message)
                        })
                        .catch(function (error) {
                            alert(error)
                        });
/*                axios.interceptors.request.use(config=>{
                    config.baseURL='' + host + '/api/task-interface?task_id=' + event.task_id + '',
                        config.tiemout=6000;
                })*/
                }
    },
            taskstop:function(index){

            },
            //编辑任务参数
            taskupdate:function(row){
                this.win=true;

/*
                this.taskwin=locust
                for (i = 0; i < locust.length; i++) {
                    var str = locust[i].parameter;
                    var reg = RegExp(/=/);
                    arr = str.split("=");
                    arr1 = str.split("=");
                    console.log("数据对象1：" + arr[0]);
                    console.log("数据对象2：" + arr[1]);
                    if (str.match(reg)) {
                        this.taskwin[i].winvalue=arr[1]
                        this.taskwin[i].status=false,
                            this.taskwin[i].arr=arr[0]
                    }
                    else{
                        this.taskwin[i].winvalue='只需勾选,只读'
                        this.taskwin[i].status=true
                    }
                }*/
                console.log("winvalue0:"+JSON.stringify(this.taskwin));
                axios.get('' + host + '/api/taskinfo/task?tid=' +row.task_id + '')
                    .then(res => {
                        let winvalue1=res.data;
                        this.addtaskdata=res;
                        //console.log("winvalue1:"+JSON.stringify(winvalue1))
                        if(row.type_id===1){
                            if(res.data.message.locust_cl.length>0){
                                for(var i=0;i<locust.length;i++){
                                    var str = locust[i].parameter;
                                    var reg = RegExp(/=/);
                                    arr = str.split("=");
                                    arr1 = str.split("=");
                                    var reg1 = RegExp(/=/);
                                    for(var j=0;j<res.data.message.locust_cl.length;j++){
                                        if (res.data.message.locust_cl[j].parameter.match(reg1)) {
                                            //console.log("数据对象：" + res.data.message.locust_cl[i].parameter);
                                            arr1 = res.data.message.locust_cl[j].parameter.split("=");
                                        }
                                       // console.log("数据对象1：" + arr1[0]);
                                        console.log("数据对象2：" + arr1[1]);
                                       // console.log("数据对象3：" + arr[0]);
                                        if (arr1[0] === arr[0]) {
                                            console.log("j___"+j);
                                            console.log("数据对象5：" + arr1[1]);
                                            locust[i].winvalue=arr1[1];
                                            locust[i]._checked=true;
                                            //console.log("s："+JSON.stringify(this.taskwin))
                                        }else if (res.data.message.locust_cl[j].parameter=== locust[i].parameter) {
                                            console.log("j1___"+j);
                                            locust[i]._checked=true;
                                        }

                                    }

                                     this.taskwin=locust;
                                    console.log("zong000"+JSON.stringify(locust[i].winvalue));
                                    console.log("zong"+JSON.stringify(this.taskwin[i].winvalue));
                                    var str0=this.taskwin[i].parameter;
                                    arr0 = str0.split("=");
                                    if (str0.match(reg)) {
                                        if(this.taskwin[i].winvalue===undefined){
                                            this.taskwin[i].winvalue=arr0[1]
                                        }else{this.taskwin[i].winvalue=this.taskwin[i].winvalue}
                                        this.taskwin[i].status=false
                                    }
                                    else {
                                        this.taskwin[i].winvalue='只需勾选,只读';
                                        this.taskwin[i].status=true
                                    }
                                   //console.log("zong"+JSON.stringify(this.taskwin))

                                }
                            }
/*
                       var str = locust[i].parameter;
                                    var reg = RegExp(/=/);
                                    arr = str.split("=");
                                    arr1 = str.split("=");
                                    console.log("数据对象1：" + arr[0]);
                                    console.log("数据对象2：" + arr[1]);
                                    if (str.match(reg)) {
                                        this.taskwin[i].winvalue=arr[1]
                                        this.taskwin[i].status=false,
                                            this.taskwin[i].arr=arr[0]
                                    }
                                    else {
                                        this.taskwin[i].winvalue='只需勾选,只读'
                                        this.taskwin[i].status=true
                                    }
                            var reg1 = RegExp(/=/);
                            //console.log("winvalue12:"+h)
                            if(res.data.message.locust_cl.length>0){
                                console.log("winvalue13:"+res.data.message.locust_cl.length)
                                /!*              if (res.data.message.locust_cl[0].parameter.match(reg1)) {
                                                  console.log("数据对象：" + res.data.message.locust_cl[0].parameter);
                                                  arr1 = res.data.message.locust_cl[0].parameter.split("=");
                                                  console.log("数据对象1：" + arr1[0]);
                                                  console.log("数据对象2：" + arr1[1]);
                                                  this.taskwin[i].winvalue=arr1[1]
                                              }*!/

                                for(var i=0;i<res.data.message.locust_cl.length;i++) {
                                    console.log("I1___"+i)
                                    if (res.data.message.locust_cl[i].parameter.match(reg1)) {
                                        //console.log("数据对象：" + res.data.message.locust_cl[i].parameter);
                                        arr1 = res.data.message.locust_cl[i].parameter.split("=");
                                        //console.log("数据对象1：" + arr1[0]);
                                        //console.log("数据对象2：" + arr1[1]);
                                        //console.log("数据对象3：" + arr[0]);
                                    }
                                    this.taskwin=locust
                                        for(var j=0;j<locust.length;j++){
                                            var str = locust[j].parameter;
                                            var reg = RegExp(/=/);
                                            arr = str.split("=");
                                            arr1 = str.split("=");
                                            console.log("数据对象1：" + arr[0]);
                                            console.log("数据对象2：" + arr[1]);
                                            if (str.match(reg)) {
                                                this.taskwin[j].winvalue=arr[1]
                                                this.taskwin[j].status=false,
                                                    this.taskwin[j].arr=arr[0]
                                            }
                                            else {
                                                this.taskwin[j].winvalue='只需勾选,只读'
                                                this.taskwin[j].status=true
                                            }
                                            //console.log("数据对象4：" + this.taskwin.length);
                                            //console.log("数据对象5：" + this.taskwin[j].arr);
                                            if (arr1[0] === arr[0]) {
                                                console.log("j___"+j)
                                                console.log("数据对象5：" + arr1[1]);
                                                this.taskwin[j].winvalue=arr1[1]
                                                this.taskwin[j]._checked=true;
                                                console.log("s："+JSON.stringify(this.taskwin))
                                            }else if (this.taskwin[j].parameter=== arr1[0]) {
                                                console.log("j1___"+j)
                                                this.taskwin[j]._checked=true;
                                            }

                                        }


                                }
                            console.log("zong："+JSON.stringify(this.taskwin))
                            }
*/

                        }
                        /*else if(row.type_id===2){
                            console.log("接口"+JSON.stringify(res))
                            console.log("接口"+JSON.stringify(res.data.message.pytest_para))
                            if(res.data.message.locust_cl.length>0){
                                for(var i=0;i<locust.length;i++){
                                    var str = locust[i].parameter;
                                    var reg = RegExp(/=/);
                                    arr = str.split("=");
                                    arr1 = str.split("=");
                                    var reg1 = RegExp(/=/);
                                    for(var j=0;j<res.data.message.locust_cl.length;j++){
                                        if (res.data.message.locust_cl[j].parameter.match(reg1)) {
                                            //console.log("数据对象：" + res.data.message.locust_cl[i].parameter);
                                            arr1 = res.data.message.locust_cl[j].parameter.split("=");
                                        }
                                        // console.log("数据对象1：" + arr1[0]);
                                        console.log("数据对象2：" + arr1[1]);
                                        // console.log("数据对象3：" + arr[0]);
                                        if (arr1[0] === arr[0]) {
                                            console.log("j___"+j)
                                            console.log("数据对象5：" + arr1[1]);
                                            locust[i].winvalue=arr1[1]
                                            locust[i]._checked=true;
                                            //console.log("s："+JSON.stringify(this.taskwin))
                                        }else if (res.data.message.locust_cl[j].parameter=== locust[i].parameter) {
                                            console.log("j1___"+j)
                                            locust[i]._checked=true;
                                        }

                                    }

                                    this.taskwin=locust;
                                    console.log("zong000"+JSON.stringify(locust[i].winvalue))
                                    console.log("zong"+JSON.stringify(this.taskwin[i].winvalue))
                                    var str0=this.taskwin[i].parameter
                                    arr0 = str0.split("=");

                                    if (str0.match(reg)) {
                                        if(this.taskwin[i].winvalue===undefined){
                                            this.taskwin[i].winvalue=arr0[1]
                                        }else{this.taskwin[i].winvalue=this.taskwin[i].winvalue}
                                        this.taskwin[i].status=false
                                    }
                                    else {
                                        this.taskwin[i].winvalue='只需勾选,只读'
                                        this.taskwin[i].status=true
                                    }
                                    //console.log("zong"+JSON.stringify(this.taskwin))

                                }
                            }
                        }*/
                    });



            },
            //删除按钮
            remove: function (index) {

                // 格局id删除数据
                var obj = {task_id:this.tableData3[index].task_id};
                console.log('date1' + JSON.stringify(obj));
                this.tableData3.splice(index, 1);
                // var url = '/api/product/delproduct'
                // 发送异步请求
                axios({
                    url: ''+host+'/api/taskinfo/task',
                    method: 'delete',
                    dataType: 'json',
                    headers: {
                        'Content-type': 'application/json;'
                    },
                    data: JSON.stringify(obj),
                }).then(res => {
                    if (res.status === 200) {
                        alert('success');
                        // 更新数据
                        console.log(res);
                        this.tableData3.splice(index, 1)
                    } else {
                        alert(res)
                    }
                }).catch(function () {
                    alert('服务连接出错了')
                })
            },
            //点击编辑
            show (row) {
                this.editFormVisible=true;
                console.log("row"+JSON.stringify(row));

                this.editForm=row;
                //this.editForm.api_json=JSON.parse(this.editForm.api_json)
                console.log("case_pdt"+JSON.stringify(this.case_pdt));
                var  performance0=[];
                var  interface0=[];

                for(var i=0;i<this.case_pdt.length;i++){
                    this.case_pdt[i]._checked=false;
                    if(this.case_pdt[i].type_id===1){
                        for(var j=0;j<this.editForm.associated_case.length;j++){
                            if(this.case_pdt[i].case_id===this.editForm.associated_case[j].case_id){
                                this.case_pdt[i]._checked="checked";
                            }
                        }
                        performance0.push({
                            case_id:this.case_pdt[i].case_id,
                            case_name:this.case_pdt[i].case_name,
                            _checked:this.case_pdt[i]._checked

                        })
                    }
                    else if(this.case_pdt[i].type_id===2){
                        for(var j=0;j<this.editForm.associated_case.length;j++){
                            if(this.case_pdt[i].case_id===this.editForm.associated_case[j].case_id){
                                this.case_pdt[i]._checked="checked";
                            }
                        }
                        interface0.push({
                            case_id:this.case_pdt[i].case_id,
                            case_name:this.case_pdt[i].case_name,
                            _checked:this.case_pdt[i]._checked
                        })
                    }
/*                    if(this.case_pdt[i].type_id===1){
                        for(var j=0;j<this.editForm.associated_case.length;j++){
                            if(this.case_pdt[i].case_id===this.editForm.associated_case[j].case_id){
                                this.editForm.associated_case[j]._checked=true;
                            }
                        }
                    }
                    console.log("this"+JSON.stringify(this.editForm))*/
/*                    else if(this.case_pdt[i].type_id===2){
                        for(var j=0;j<this.editForm.associated_case.length;j++){
                            if(this.case_pdt[i].case_id===this.editForm.associated_case[j].case_id){
                                this.editForm.associated_case[j]._checked=true;
                            }else{this.editForm.associated_case[j]._checked=false;}
                        }
                    }*/

/*                    console.log("h--"+i+JSON.stringify(this.case_pdt[i].type_id))
                    console.log("h1--"+i+JSON.stringify(this.editForm.associated_case))
                    for(var j=0;j<this.editForm.associated_case.length;j++){
                        console.log("hello1"+JSON.stringify(this.case_pdt[i].type_id))
                        if(this.case_pdt[i].type_id===1){
                            console.log("hello2"+JSON.stringify(this.editForm.associated_case[j]))
                            if(this.case_pdt[i].case_id===this.editForm.associated_case[j].case_id){
                                console.log("cs ")
                                performance0.push({
                                    case_id:this.case_pdt[i].case_id,
                                    case_name:this.case_pdt[i].case_name,
                                    _checked:true,
                                    _isChecked:true
                                })
                            }else{
                                performance0.push({
                                    case_id:this.case_pdt[i].case_id,
                                    case_name:this.case_pdt[i].case_name,
                                    _checked:false,
                                    _isChecked:false
                                })
                            }

                            //console.log("performance0:"+performance0)
                        }
                        else if(this.case_pdt[i].type_id===2){
                            if(this.case_pdt[i].case_id===this.editForm.associated_case[j].case_id){
                                interface0.push({
                                    case_id:this.case_pdt[i].case_id,
                                    case_name:this.case_pdt[i].case_name,
                                    _checked:true,
                                    _isChecked:true
                                })
                            }else{
                                interface0.push({
                                    case_id:this.case_pdt[i].case_id,
                                    case_name:this.case_pdt[i].case_name,
                                    _checked:false,
                                    _isChecked:false
                                })
                            }
          /!*                  interface0.push({
                                case_id:this.case_pdt[i].case_id,
                                case_name:this.case_pdt[i].case_name,

                            })*!/


                        }
                    }*/
                }
                console.log("interface0:"+JSON.stringify(interface0));
                console.log("interface1:"+JSON.stringify(performance0));
                if(this.editForm.type_id===1){
                    this.editForm.per=performance0;
                    this.editForm.per[0].checked="checked";
                }else if(this.editForm.type_id===2){
                    this.editForm.per=interface0;
                }
                console.log("editForm"+JSON.stringify(this.editForm))
                /*this.$options.watch.task_typeID(this.editForm.type_id)*/
                /*                  this.$Modal.confirm({
                                      title: '编辑产品',
                                      fullscreen:true,
                                      title: '编辑产品',
                                      content: `
                                              产品名称：<input size="35"v-bind:value="${this.tableData3[index].pdt_name}"
                  v-on:input="${this.tableData3[index].pdt_name} = $event.target.value" /><br>
                                             <br>产品版本：<input  size="35"value="${this.tableData3[index].version}"/><br>
                                             <br>产品地址：<input size="35" value="${this.tableData3[index].host}"/><br>
                                             <br>产品描述：<input size="35" value="${this.tableData3[index].description}"/><br>
                                             <br>api_json ：<input  size="35" value=${JSON.stringify(this.tableData3[index].api_json)}/>`,
                                      onOk: () => {
                                          this.$Message.info('点击了确定');
                                          console.log("修改数据:"+JSON.stringify(this.tableData3[index]));
                                          axios({
                                              url: ''+host+'/api/product/updateproduct',
                                              "method": "PUT",
                                              dataType: 'json',
                                              headers: {
                                                  'Content-type': 'application/json;'
                                              },
                                              data: JSON.stringify(this.tableData3[index]),
                                          }).then(function (response){
                                              console.log("修改产品："+JSON.stringify(response))
                                              alert("操作:"+response.data.title+",\n结果:"+response.data.message)
                                              location.reload()

                                          })
                                              .catch(function(error){
                                                  console.log(error)
                                              })

                                      },
                                      onCancel: () => {
                                          this.$Message.info('点击了取消');
                                      }
                                  })*/
            },
            //添加弹窗点击确定
            ok :function (){
                //let api_json = JSON.parse(this.case_api )
                //this.formValidate.api_json=api_json
                console.log("task_list:"+JSON.stringify(this.case_token));
                console.log("slection:"+JSON.stringify(this.selection));
                console.log("task_name:"+JSON.stringify(this.task_name));
                console.log("task_typeID:"+JSON.stringify(this.task_typeID));
/*                var parameter='--web-host='+host.substring(7,)+''
                console.log("parameter:"+parameter)*/
                if(this.task_typeID==='1'){

                    var obj={
                        "task_name":this.task_name,
                        "associated_case":this.selection,
                        "task_status": false,
                        "locust_cl": [
                            {
                                "need": 1,
                                "parameter": "--host=127.0.0.1"
                            },
                            {
                                "need": 1,
                                "parameter": '--web-host='+host.substring(7,)+''
                            },
                            {
                                "need": 1,
                                "parameter": "--web-port=8182"
                            }],
                        "pytest_para":[]
                    }
                }else if(this.task_typeID==='2'){
                    var obj={
                        "task_name":this.task_name,
                        "associated_case":this.case_token,
                        "task_status": false,
                        "locust_cl":[],
                        "pytest_para":    [{
                            "parameter": "--disable-warnings",
                            "description": "禁用警告"
                        }
                ]
                    }
                }

                console.log("api_id10:"+JSON.stringify(obj));
                axios({
                    url: ''+host+'/api/taskinfo/task',
                    method: 'post',
                    dataType: 'json',
                    headers: {
                        'Content-type': 'application/json;'
                    },
                    data: JSON.stringify(obj),
                }).then(function (response){
                    console.log(response);
                    alert("操作:"+response.data.title+",\n结果:"+response.data.message);
                    setTimeout('location.reload()',200);

                })
                    .catch(function(error){
                        alert("请求超时");
                        console.log(error)
                    })

            },
            //编辑更新
            update() {
                console.log("修改1:"+JSON.stringify(this.editForm));
                console.log("修改a:"+JSON.stringify(this.selection));
                if(this.selection===undefined){
                    this.selection=this.editForm.associated_case
                }
                axios.get('' + host + '/api/taskinfo/task?tid=' +this.editForm.task_id + '')
                    .then(res => {
console.log(res);
                        obj={
                            "task_id": this.editForm.task_id,
                            "task_name": this.editForm.task_name,
                            "associated_case":this.selection,
                            "task_status": res.data.message.task_status,
                            "locust_cl":res.data.message.locust_cl,
                            "pytest_para":res.data.message.pytest_para
                        };
                        console.log("ss:"+JSON.stringify(obj));
                        axios({
                            //url: ''+host+'/api/taskinfo/task',
                            method: 'put',
                            dataType: 'json',
                            headers: {
                                'Content-type': 'application/json;'
                            },
                            data: JSON.stringify(obj),
                        }).then(function (response){
                            console.log(response);
                            alert("操作:"+response.data.title+",\n结果:"+response.data.message);
                            location.reload()

                        })
                            .catch(function(error){
                                console.log(error)
                            })
                    })

            },
            //任务参数编辑更新
            addtaskwin(){
                //alert("确定")
                console.log("this.selection"+JSON.stringify(this.selection));
                obj={
                    "task_id": this.addtaskdata.data.message.task_id,
                    "task_name": this.addtaskdata.data.message.task_name,
                    "associated_case":this.addtaskdata.data.message.associated_case,
                    "task_status": this.addtaskdata.data.message.task_status,
                    "locust_cl":this.selection,
                    "pytest_para":this.addtaskdata.data.message.pytest_para
                };
                console.log("ss:"+JSON.stringify(obj));
                axios({
                    url: ''+host+'/api/taskinfo/task',
                    method: 'put',
                    dataType: 'json',
                    headers: {
                        'Content-type': 'application/json;'
                    },
                    data: JSON.stringify(obj),
                }).then(function (response){
                    console.log(response);
                    alert("操作:"+response.data.title+",\n结果:"+response.data.message)
                    //location.reload()

                })
                    .catch(function(error){
                        console.log(error)
                    })
            },
            cancel () {
/*                this.$Message.info('已取消');
                this.formValidate = {
                    pdt_name: '123',
                    version: '',
                    host: '',
                    description: '',
                    api_json: ''
                };*/
                this.$Message.info('已取消');
                setTimeout('location.reload()',500);
            },

        }
    });
</script>
</body>

</html>
